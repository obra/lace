name: Debug Signing Setup

on:
  workflow_dispatch:       # Manual trigger only
  push:
    branches: [ autoupdate ] # Only on this branch for debugging

permissions:
  contents: read

jobs:
  debug-keychain:
    name: Debug Keychain and Signing
    runs-on: [self-hosted, macOS]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check secrets availability
        id: secrets_check
        run: |
          echo "üîç Checking secrets..."
          [ -n "$APPLE_DEVELOPER_CERTIFICATE_P12" ] && echo "  ‚úÖ APPLE_DEVELOPER_CERTIFICATE_P12: Present (${#APPLE_DEVELOPER_CERTIFICATE_P12} chars)" || echo "  ‚ùå APPLE_DEVELOPER_CERTIFICATE_P12: Missing"
          [ -n "$APPLE_DEVELOPER_CERTIFICATE_PASSWORD" ] && echo "  ‚úÖ APPLE_DEVELOPER_CERTIFICATE_PASSWORD: Present" || echo "  ‚ùå APPLE_DEVELOPER_CERTIFICATE_PASSWORD: Missing"
          [ -n "$APPLE_ID_EMAIL" ] && echo "  ‚úÖ APPLE_ID_EMAIL: Present ($APPLE_ID_EMAIL)" || echo "  ‚ùå APPLE_ID_EMAIL: Missing"
          [ -n "$APPLE_ID_PASSWORD" ] && echo "  ‚úÖ APPLE_ID_PASSWORD: Present" || echo "  ‚ùå APPLE_ID_PASSWORD: Missing"
          [ -n "$APPLE_TEAM_ID" ] && echo "  ‚úÖ APPLE_TEAM_ID: Present ($APPLE_TEAM_ID)" || echo "  ‚ùå APPLE_TEAM_ID: Missing"
        env:
          APPLE_DEVELOPER_CERTIFICATE_P12: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12 }}
          APPLE_DEVELOPER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
          APPLE_ID_EMAIL: ${{ secrets.APPLE_ID_EMAIL }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Test P12 certificate decode
        run: |
          echo "üß™ Testing P12 certificate decode..."
          echo "$APPLE_DEVELOPER_CERTIFICATE_P12" | base64 --decode > test-cert.p12
          
          echo "üìä Certificate file info:"
          ls -la test-cert.p12
          file test-cert.p12
          
          echo "üîç Certificate contents (basic check):"
          openssl pkcs12 -in test-cert.p12 -nokeys -noout -info -passin pass:"$APPLE_DEVELOPER_CERTIFICATE_PASSWORD" || echo "‚ùå Failed to read certificate"
          
          rm test-cert.p12
        env:
          APPLE_DEVELOPER_CERTIFICATE_P12: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12 }}
          APPLE_DEVELOPER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}

      - name: Test keychain setup step by step
        run: |
          echo "üîß Setting up keychain step by step..."
          
          # Save original keychain
          ORIGINAL_KEYCHAIN=$(security default-keychain 2>/dev/null | tr -d '"' || echo "no-default")
          echo "üìã Original keychain: $ORIGINAL_KEYCHAIN"
          
          # Create temp keychain
          KEYCHAIN_NAME="debug-keychain-$(date +%s).keychain"
          KEYCHAIN_PASSWORD="debug-pass-$(date +%s)"
          echo "üîê Creating keychain: $KEYCHAIN_NAME"
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          echo "‚úÖ Keychain created"
          
          security default-keychain -s "$KEYCHAIN_NAME"
          echo "‚úÖ Set as default"
          
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          echo "‚úÖ Unlocked keychain"
          
          # Import certificate
          echo "üì• Importing certificate..."
          echo "$APPLE_DEVELOPER_CERTIFICATE_P12" | base64 --decode > temp-cert.p12
          
          security import temp-cert.p12 -k "$KEYCHAIN_NAME" -P "$APPLE_DEVELOPER_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productsign -T /usr/bin/security
          echo "‚úÖ Certificate imported"
          
          # Set partition list
          echo "üîß Setting partition list..."
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          echo "‚úÖ Partition list set"
          
          # Verify what's in the keychain
          echo "üîç Checking keychain contents..."
          security find-identity -v -p codesigning "$KEYCHAIN_NAME"
          
          echo "üîç Checking global codesigning access..."
          security find-identity -v -p codesigning
          
          # Test actual codesign
          echo "üß™ Testing codesign with a dummy file..."
          echo "test" > test-file.txt
          
          # Try to find any signing identity
          SIGNING_IDENTITY=$(security find-identity -v -p codesigning | grep '"' | head -n1 | sed 's/.*"\(.*\)".*/\1/' || echo "")
          
          if [ -n "$SIGNING_IDENTITY" ]; then
            echo "üîë Found identity: $SIGNING_IDENTITY"
            echo "üß™ Testing codesign..."
            codesign -s "$SIGNING_IDENTITY" test-file.txt && echo "‚úÖ Codesign test successful" || echo "‚ùå Codesign test failed"
          else
            echo "‚ùå No signing identity found"
          fi
          
          # Cleanup
          rm -f temp-cert.p12 test-file.txt
          
          # Restore original keychain
          if [ "$ORIGINAL_KEYCHAIN" != "no-default" ]; then
            security default-keychain -s "$ORIGINAL_KEYCHAIN" || true
          fi
          
          # Delete test keychain
          security delete-keychain "$KEYCHAIN_NAME" || true
          
        env:
          APPLE_DEVELOPER_CERTIFICATE_P12: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12 }}
          APPLE_DEVELOPER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}