name: Build Single-File Executable

on:
  push:
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build-executable:
    name: Build Executable
    if: ${{ (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository) && github.actor == 'obra' }}
    strategy:
      matrix:
        include:
          - os: macos-latest
            runner: [self-hosted, macOS]
            target: bun-darwin-arm64
            name: lace-macos-arm64
    
    runs-on: ${{ matrix.runner }}
    
    steps:
    - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1
    
    - name: Setup Node.js
      uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
      with:
        node-version: '20'
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v1.2.2
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: |
        npm install
        cd packages/web && npm install
    
    - name: Setup Apple Code Signing
      if: runner.os == 'macOS'
      run: |
        # Save original default keychain
        ORIGINAL_KEYCHAIN=$(security default-keychain | tr -d '"')
        echo "ORIGINAL_KEYCHAIN=$ORIGINAL_KEYCHAIN" >> $GITHUB_ENV
        
        # Create temporary keychain for signing
        KEYCHAIN_NAME="github-actions-$(date +%s).keychain"
        KEYCHAIN_PASSWORD="temp-keychain-pass-$(date +%s)"
        
        # Create and unlock keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
        security default-keychain -s "$KEYCHAIN_NAME"
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
        
        # Decode and import P12 certificate
        echo "$APPLE_DEVELOPER_CERTIFICATE_P12" | base64 --decode > temp-cert.p12
        security import temp-cert.p12 -k "$KEYCHAIN_NAME" -P "$APPLE_DEVELOPER_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
        
        # Set partition list for codesign access
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
        
        # Clean up certificate file
        rm temp-cert.p12
        
        # Export for use in build step
        echo "KEYCHAIN_NAME=$KEYCHAIN_NAME" >> $GITHUB_ENV
        echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV
      env:
        APPLE_DEVELOPER_CERTIFICATE_P12: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12 }}
        APPLE_DEVELOPER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
    
    # Web build is invoked by scripts/build-macos-app.ts
    
    - name: Build executable
      env:
        APPLE_DEVELOPER_CERTIFICATE_P12: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12 }}
        APPLE_DEVELOPER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
        APPLE_ID_EMAIL: ${{ secrets.APPLE_ID_EMAIL }}
        APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        if [[ "${{ matrix.target }}" == *"darwin"* ]]; then
          # For releases (tags), build signed DMG; for PRs, build app bundle only
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            bun scripts/build-macos-app.ts --target ${{ matrix.target }} --name Lace --dmg --sign
          else
            bun scripts/build-macos-app.ts --target ${{ matrix.target }} --name Lace --bundle
          fi
        else
          bun scripts/build-macos-app.ts --target ${{ matrix.target }} --name ${{ matrix.name }}
        fi
    
    - name: Sign and notarize macOS executable (PR builds only)
      if: runner.os == 'macOS' && github.event_name == 'pull_request'
      env:
        APPLE_DEVELOPER_CERTIFICATE_P12: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12 }}
        APPLE_DEVELOPER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
        APPLE_ID_EMAIL: ${{ secrets.APPLE_ID_EMAIL }}
        APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # For PR builds, sign the app bundle (release builds include signing in build step)
        npx tsx scripts/sign-and-notarize.ts --binary "build/Lace.app"
    
    - name: Test executable
      run: |
        if [[ "${{ matrix.target }}" == *"darwin"* ]]; then
          # Test the app bundle and check for DMG if it's a release
          ls -la build/Lace.app/Contents/MacOS/
          echo "âœ… App bundle structure verified"
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            ls -la build/*.dmg && echo "âœ… DMG created successfully"
          fi
        else
          chmod +x build/${{ matrix.name }}
          ./build/${{ matrix.name }} --help
        fi
    
    - name: Upload executable
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: ${{ matrix.name }}
        path: |
          ${{ matrix.target == 'bun-darwin-arm64' && 'build/Lace.app' || format('build/{0}', matrix.name) }}
        retention-days: 7
    
    - name: Upload DMG (releases only)
      if: startsWith(github.ref, 'refs/tags/') && matrix.target == 'bun-darwin-arm64'
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: ${{ matrix.name }}-dmg
        path: build/*.dmg
        retention-days: 90
    
    - name: Create archive
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cd build
        if [[ "${{ matrix.target }}" == *"darwin"* ]]; then
          # For macOS releases, we now have DMG files - no need to create tar.gz
          echo "DMG files created - skipping tar.gz creation for macOS"
        else
          tar -czf ${{ matrix.name }}.tar.gz ${{ matrix.name }}
        fi
    
    - name: Upload release asset
      if: startsWith(github.ref, 'refs/tags/') && matrix.target != 'bun-darwin-arm64'
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: ${{ matrix.name }}.tar.gz
        path: build/${{ matrix.name }}.tar.gz
        retention-days: 90
    
    - name: Cleanup Keychain
      if: always() && runner.os == 'macOS'
      run: |
        # Restore original default keychain if we saved one
        if [ -n "$ORIGINAL_KEYCHAIN" ]; then
          security default-keychain -s "$ORIGINAL_KEYCHAIN" || true
          echo "âœ… Restored original default keychain: $ORIGINAL_KEYCHAIN"
        fi
        
        # Delete temporary keychain
        if [ -n "$KEYCHAIN_NAME" ]; then
          security delete-keychain "$KEYCHAIN_NAME" || true
          echo "ðŸ§¹ Cleaned up temporary keychain"
        fi

  create-release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: build-executable
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-assets
    
    - name: Display structure of downloaded files
      run: ls -la release-assets
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Lace Single-File Executable ${{ github.ref_name }}
        body: |
          ## Lace Single-File Executable ${{ github.ref_name }}
          
          Standalone Lace executables with embedded Next.js, React, and all assets.
          No external dependencies required.
          
          ### Downloads
          
          - **Lace-\<version\>-\<sha\>.dmg** - macOS Disk Image for Apple Silicon (M1/M2/M3/M4)
            - Signed and notarized for macOS Gatekeeper
            - Professional installer experience
            - Drag-and-drop to Applications folder
          
          ### Installation
          
          **macOS (DMG):**
          1. Download the `.dmg` file
          2. Double-click to mount the disk image
          3. Drag `Lace.app` to the `Applications` folder
          4. Launch Lace from Applications or Launchpad
          
          ### Features
          
          - Complete Lace environment in a single executable
          - Embedded Next.js web interface with React components
          - Asset bundling with all dependencies embedded
          - No installation required beyond drag-and-drop
          - Self-contained with no external dependencies
          - Code signed and notarized for macOS security
          - Professional DMG installer with version info
          
          Built from commit ${{ github.sha }}
        files: |
          release-assets/**/*.tar.gz
          release-assets/**/*.dmg
        draft: false
        prerelease: false
        generate_release_notes: true
    
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
