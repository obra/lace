name: Build Single-File Executable

on:
  push:
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build-executable:
    name: Build Executable
    strategy:
      matrix:
        include:
          - os: macos-latest
            runner: [self-hosted, macOS]
            target: bun-darwin-arm64
            name: lace-macos-arm64
    
    runs-on: ${{ matrix.runner }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: |
        npm install
        cd packages/web && npm install
    
    - name: Build Next.js app
      run: |
        cd packages/web && npm run build
    
    - name: Build executable
      run: |
        if [[ "${{ matrix.target }}" == *"darwin"* ]]; then
          npx tsx scripts/build-simple.ts --target ${{ matrix.target }} --name ${{ matrix.name }} --bundle
        else
          npx tsx scripts/build-simple.ts --target ${{ matrix.target }} --name ${{ matrix.name }}
        fi
    
    - name: Sign and notarize macOS executable
      if: runner.os == 'macOS' && startsWith(github.ref, 'refs/tags/')
      env:
        APPLE_DEVELOPER_CERTIFICATE_P12: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12 }}
        APPLE_DEVELOPER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
        APPLE_ID_EMAIL: ${{ secrets.APPLE_ID_EMAIL }}
        APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        if [[ "${{ matrix.target }}" == *"darwin"* ]]; then
          npx tsx scripts/sign-and-notarize.ts --binary "build/Lace.app"
        else
          npx tsx scripts/sign-and-notarize.ts --binary "build/${{ matrix.name }}"
        fi
    
    - name: Test executable
      run: |
        if [[ "${{ matrix.target }}" == *"darwin"* ]]; then
          # Test the app bundle
          ls -la build/Lace.app/Contents/MacOS/
          echo "âœ… App bundle structure verified"
        else
          chmod +x build/${{ matrix.name }}
          ./build/${{ matrix.name }} --help
        fi
    
    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}
        path: |
          ${{ matrix.target == 'bun-darwin-arm64' && 'build/Lace.app' || format('build/{0}', matrix.name) }}
        retention-days: 7
    
    - name: Create archive
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cd build
        if [[ "${{ matrix.target }}" == *"darwin"* ]]; then
          tar -czf ${{ matrix.name }}.tar.gz Lace.app
        else
          tar -czf ${{ matrix.name }}.tar.gz ${{ matrix.name }}
        fi
    
    - name: Upload release asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}.tar.gz
        path: build/${{ matrix.name }}.tar.gz
        retention-days: 90

  create-release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: build-executable
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-assets
    
    - name: Display structure of downloaded files
      run: ls -la release-assets
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Lace Single-File Executable ${{ github.ref_name }}
        body: |
          ## Lace Single-File Executable ${{ github.ref_name }}
          
          Standalone Lace executables with embedded Next.js, React, and all assets.
          No external dependencies required.
          
          ### Downloads
          
          - **lace-macos-arm64.tar.gz** - macOS App Bundle for Apple Silicon (M1/M2/M3/M4)
          - **lace-linux-x64.tar.gz** - Linux x86_64
          
          ### Usage
          
          **macOS (App Bundle):**
          ```bash
          # Extract archive
          tar -xzf lace-macos-arm64.tar.gz
          
          # Run Lace (opens menu bar app)
          open Lace.app
          ```
          
          **Linux:**
          ```bash
          # Extract archive
          tar -xzf lace-linux-x64.tar.gz
          
          # Run Lace
          ./lace-linux-x64 --help
          ./lace-linux-x64 --port 3000
          ```
          
          ### Features
          
          - Complete Lace environment in a single executable
          - Embedded Next.js web interface with React components
          - ZIP-based asset bundling with all dependencies
          - No installation required - just download and run
          - Self-contained with no external dependencies
          
          Built from commit ${{ github.sha }}
        files: release-assets/**/*.tar.gz
        draft: false
        prerelease: false
        generate_release_notes: true
    
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}