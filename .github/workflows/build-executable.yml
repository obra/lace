name: Build Single-File Executable

on:
  push:
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build-executable:
    name: Build Executable
    if: ${{ (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository) && github.actor == 'obra' }}
    strategy:
      matrix:
        include:
          - os: macos-latest
            runner: [self-hosted, macOS]
            target: bun-darwin-arm64
            name: lace-macos-arm64
    
    runs-on: ${{ matrix.runner }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: |
        npm install
        cd packages/web && npm install
    
    # Web build is invoked by scripts/build-macos-app.ts
    
    - name: Build executable
      env:
        APPLE_DEVELOPER_CERTIFICATE_P12: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12 }}
        APPLE_DEVELOPER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
        APPLE_ID_EMAIL: ${{ secrets.APPLE_ID_EMAIL }}
        APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        if [[ "${{ matrix.target }}" == *"darwin"* ]]; then
          # For releases (tags), build signed DMG; for PRs, build app bundle only
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            bun scripts/build-macos-app.ts --target ${{ matrix.target }} --name Lace --dmg --sign
          else
            bun scripts/build-macos-app.ts --target ${{ matrix.target }} --name Lace --bundle
          fi
        else
          bun scripts/build-macos-app.ts --target ${{ matrix.target }} --name ${{ matrix.name }}
        fi
    
    - name: Sign and notarize macOS executable (PR builds only)
      if: runner.os == 'macOS' && github.event_name == 'pull_request'
      env:
        APPLE_DEVELOPER_CERTIFICATE_P12: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12 }}
        APPLE_DEVELOPER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
        APPLE_ID_EMAIL: ${{ secrets.APPLE_ID_EMAIL }}
        APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # For PR builds, sign the app bundle (release builds include signing in build step)
        npx tsx scripts/sign-and-notarize.ts --binary "build/Lace.app"
    
    - name: Test executable
      run: |
        if [[ "${{ matrix.target }}" == *"darwin"* ]]; then
          # Test the app bundle and check for DMG if it's a release
          ls -la build/Lace.app/Contents/MacOS/
          echo "✅ App bundle structure verified"
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            ls -la build/*.dmg && echo "✅ DMG created successfully"
          fi
        else
          chmod +x build/${{ matrix.name }}
          ./build/${{ matrix.name }} --help
        fi
    
    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}
        path: |
          ${{ matrix.target == 'bun-darwin-arm64' && 'build/Lace.app' || format('build/{0}', matrix.name) }}
        retention-days: 7
    
    - name: Upload DMG (releases only)
      if: startsWith(github.ref, 'refs/tags/') && matrix.target == 'bun-darwin-arm64'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}-dmg
        path: build/*.dmg
        retention-days: 90
    
    - name: Create archive
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cd build
        if [[ "${{ matrix.target }}" == *"darwin"* ]]; then
          # For macOS releases, we now have DMG files - no need to create tar.gz
          echo "DMG files created - skipping tar.gz creation for macOS"
        else
          tar -czf ${{ matrix.name }}.tar.gz ${{ matrix.name }}
        fi
    
    - name: Upload release asset
      if: startsWith(github.ref, 'refs/tags/') && matrix.target != 'bun-darwin-arm64'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}.tar.gz
        path: build/${{ matrix.name }}.tar.gz
        retention-days: 90

  create-release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: build-executable
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-assets
    
    - name: Display structure of downloaded files
      run: ls -la release-assets
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Lace Single-File Executable ${{ github.ref_name }}
        body: |
          ## Lace Single-File Executable ${{ github.ref_name }}
          
          Standalone Lace executables with embedded Next.js, React, and all assets.
          No external dependencies required.
          
          ### Downloads
          
          - **Lace-\<version\>-\<sha\>.dmg** - macOS Disk Image for Apple Silicon (M1/M2/M3/M4)
            - Signed and notarized for macOS Gatekeeper
            - Professional installer experience
            - Drag-and-drop to Applications folder
          
          ### Installation
          
          **macOS (DMG):**
          1. Download the `.dmg` file
          2. Double-click to mount the disk image
          3. Drag `Lace.app` to the `Applications` folder
          4. Launch Lace from Applications or Launchpad
          
          ### Features
          
          - Complete Lace environment in a single executable
          - Embedded Next.js web interface with React components
          - Asset bundling with all dependencies embedded
          - No installation required beyond drag-and-drop
          - Self-contained with no external dependencies
          - Code signed and notarized for macOS security
          - Professional DMG installer with version info
          
          Built from commit ${{ github.sha }}
        files: |
          release-assets/**/*.tar.gz
          release-assets/**/*.dmg
        draft: false
        prerelease: false
        generate_release_notes: true
    
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
