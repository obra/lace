---
title: "9:33:44 AM - July 28, 2025"
date: 2025-07-28T13:33:44.726Z
timestamp: 1753709624726
---

## Project Notes

Based on the planning documents, here's the intended architecture:

**Agent States**: idle → thinking → streaming → tool_execution → idle (with event-driven transitions)

**Tool Execution Flow**:
1. LLM returns tool calls → Agent creates TOOL_CALL events → Agent goes idle immediately
2. Tool approval system creates TOOL_APPROVAL_REQUEST events (if needed)
3. User approvals trigger TOOL_APPROVAL_RESPONSE events
4. Agent handles these events and executes tools
5. When all tools complete: if no rejections, auto-continue; if rejections, wait for user

**The Issue**: My fix made sendMessage() wait for the entire flow, but it should only wait for step 1. The rest happens via events.

**Test Failures**: Tests expect the agent to go idle immediately after processing tool calls, not wait for tool execution to complete. This is correct behavior.

**Database Errors**: These are happening because some operations are still fire-and-forget even after the main sendMessage() flow completes. I need to identify which specific operations are causing this.
