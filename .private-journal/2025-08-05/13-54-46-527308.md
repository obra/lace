---
title: "1:54:46 PM - August 5, 2025"
date: 2025-08-05T17:54:46.527Z
timestamp: 1754416486527
---

## Project Notes

Jesse is asking the key question: what does `setupTestPersistence()` actually provide that we can't get just by setting LACE_DIR and using normal persistence initialization?

Let me think through what `setupTestPersistence()` does:
1. Creates a temporary database file
2. Calls `resetPersistence()` to clear any existing persistence state
3. Calls `initializePersistence(dbPath)` to initialize with that temp DB
4. Returns the persistence instance

But if `temp-lace-dir.ts` sets LACE_DIR to a temp directory, and the normal persistence system uses `getLaceDbPath()` which returns `${LACE_DIR}/lace.db`, then:

- The database would automatically be at `/tmp/lace-test-abc123/lace.db` 
- Each test gets its own isolated temp directory
- The database gets cleaned up when the temp directory is removed

So maybe the only thing we need is:
1. `temp-lace-dir.ts` sets LACE_DIR
2. Tests call normal `initializePersistence(getLaceDbPath())` or similar
3. Database automatically goes to the right isolated location

The question is: does the normal application startup code already handle persistence initialization? Or do tests need to explicitly initialize it?

If tests need explicit initialization, then maybe `setupTestPersistence()` just becomes:

```typescript
export function setupTestPersistence(): DatabasePersistence {
  resetPersistence();
  initializePersistence(getLaceDbPath()); // Uses current LACE_DIR
  return getPersistence();
}
```

No more temp file creation - just use the standard location which is already isolated by temp-lace-dir.ts.
