---
title: "4:11:12 PM - August 9, 2025"
date: 2025-08-09T23:11:12.173Z
timestamp: 1754781072173
---

## Project Notes

Compaction Token Counting Bug:

In the compaction.e2e.test.ts, the test expects token usage to drop after compaction, but it's at 105.83% instead of <80%.

Looking at line 386-395, we verify compaction happened (COMPACTION event exists) but token counting isn't being updated properly.

The MSW mock is set up to:
- Return high token counts (9500 input tokens) for message 4 to trigger compaction
- Return low token counts (500 input, 100 output) for the summary

But the final token count calculation still shows over 100% usage, meaning it's still counting ALL messages including the ones that got compacted.

Need to check:
1. How Session API calculates token usage (GET handler)
2. Whether compacted events should be excluded from counts
3. Whether TokenBudgetManager gets updated after compaction
